#!/bin/bash
# File Backup Script
# Generated by Ansible

BACKUP_DIR="{{ backup_base_dir }}/daily"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/files_{{ inventory_hostname }}_${DATE}.tar.gz"
LOG_FILE="{{ backup_base_dir }}/logs/files.log"

# Paths to backup
BACKUP_PATHS=(
{% for path in backup_paths | default(['/var/www']) %}
    "{{ path }}"
{% endfor %}
)

echo "========================================" >> $LOG_FILE
echo "Backup started: $(date)" >> $LOG_FILE
echo "Paths: ${BACKUP_PATHS[@]}" >> $LOG_FILE

# Create tar archive
tar -czf "$BACKUP_FILE" \
    --exclude='*.log' \
    --exclude='*.tmp' \
    --exclude='node_modules' \
    --exclude='vendor' \
    --exclude='.git' \
    "${BACKUP_PATHS[@]}" 2>> $LOG_FILE

if [ $? -eq 0 ]; then
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "Backup successful: $BACKUP_FILE ($SIZE)" >> $LOG_FILE
    
{% if backup_encryption_enabled %}
    # Encrypt backup
    echo "Encrypting backup..." >> $LOG_FILE
    gpg --symmetric --cipher-algo AES256 \
        --passphrase "{{ backup_encryption_key }}" \
        --batch --yes "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        rm "$BACKUP_FILE"
        BACKUP_FILE="${BACKUP_FILE}.gpg"
        echo "Encryption successful" >> $LOG_FILE
    fi
{% endif %}

{% if remote_backup_enabled %}
    # Sync to remote
    echo "Syncing to remote..." >> $LOG_FILE
    rsync -avz -e "ssh -i /root/.ssh/backup_key" \
        "$BACKUP_FILE" \
        "{{ remote_backup_user }}@{{ remote_backup_host }}:{{ remote_backup_path }}/{{ inventory_hostname }}/files/"
{% endif %}

else
    echo "Backup FAILED!" >> $LOG_FILE
    
{% if slack_webhook %}
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"âŒ File backup failed on {{ inventory_hostname }}\"}" \
        "{{ slack_webhook }}"
{% endif %}
    
    exit 1
fi

echo "Backup completed: $(date)" >> $LOG_FILE
