#!/bin/bash
# MySQL Backup Script
# Generated by Ansible

DATABASE=$1
BACKUP_DIR="{{ backup_base_dir }}/daily"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DATABASE}_${DATE}.sql.gz"
LOG_FILE="{{ backup_base_dir }}/logs/mysql_${DATABASE}.log"

echo "========================================" >> $LOG_FILE
echo "Backup started: $(date)" >> $LOG_FILE
echo "Database: $DATABASE" >> $LOG_FILE

# Perform backup
mysqldump \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --add-drop-database \
    --databases "$DATABASE" | pigz -9 > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "Backup successful: $BACKUP_FILE ($SIZE)" >> $LOG_FILE
    
{% if backup_encryption_enabled %}
    # Encrypt backup
    echo "Encrypting backup..." >> $LOG_FILE
    gpg --symmetric --cipher-algo AES256 \
        --passphrase "{{ backup_encryption_key }}" \
        --batch --yes "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        rm "$BACKUP_FILE"
        BACKUP_FILE="${BACKUP_FILE}.gpg"
        echo "Encryption successful" >> $LOG_FILE
    fi
{% endif %}

{% if remote_backup_enabled %}
    # Sync to remote
    echo "Syncing to remote..." >> $LOG_FILE
    rsync -avz -e "ssh -i /root/.ssh/backup_key" \
        "$BACKUP_FILE" \
        "{{ remote_backup_user }}@{{ remote_backup_host }}:{{ remote_backup_path }}/{{ inventory_hostname }}/mysql/"
    
    if [ $? -eq 0 ]; then
        echo "Remote sync successful" >> $LOG_FILE
    else
        echo "Remote sync failed!" >> $LOG_FILE
    fi
{% endif %}

{% if s3_backup_enabled %}
    # Upload to S3
    echo "Uploading to S3..." >> $LOG_FILE
    aws s3 cp "$BACKUP_FILE" \
        "s3://{{ s3_bucket }}/{{ inventory_hostname }}/mysql/$(basename $BACKUP_FILE)" \
        --region {{ s3_region }}
    
    if [ $? -eq 0 ]; then
        echo "S3 upload successful" >> $LOG_FILE
    else
        echo "S3 upload failed!" >> $LOG_FILE
    fi
{% endif %}

else
    echo "Backup FAILED!" >> $LOG_FILE
    
{% if slack_webhook %}
    # Send alert
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"âŒ MySQL backup failed: $DATABASE on {{ inventory_hostname }}\"}" \
        "{{ slack_webhook }}"
{% endif %}
    
    exit 1
fi

echo "Backup completed: $(date)" >> $LOG_FILE
