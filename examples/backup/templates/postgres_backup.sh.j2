#!/bin/bash
# PostgreSQL Backup Script
# Generated by Ansible

DATABASE=$1
BACKUP_DIR="{{ backup_base_dir }}/daily"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DATABASE}_${DATE}.sql.gz"
LOG_FILE="{{ backup_base_dir }}/logs/postgres_${DATABASE}.log"

echo "========================================" >> $LOG_FILE
echo "Backup started: $(date)" >> $LOG_FILE
echo "Database: $DATABASE" >> $LOG_FILE

# Perform backup
sudo -u postgres pg_dump \
    --format=custom \
    --no-owner \
    --no-acl \
    "$DATABASE" | pigz -9 > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "Backup successful: $BACKUP_FILE ($SIZE)" >> $LOG_FILE
    
{% if backup_encryption_enabled %}
    # Encrypt backup
    echo "Encrypting backup..." >> $LOG_FILE
    gpg --symmetric --cipher-algo AES256 \
        --passphrase "{{ backup_encryption_key }}" \
        --batch --yes "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        rm "$BACKUP_FILE"
        BACKUP_FILE="${BACKUP_FILE}.gpg"
        echo "Encryption successful" >> $LOG_FILE
    fi
{% endif %}

{% if remote_backup_enabled %}
    # Sync to remote
    echo "Syncing to remote..." >> $LOG_FILE
    rsync -avz -e "ssh -i /root/.ssh/backup_key" \
        "$BACKUP_FILE" \
        "{{ remote_backup_user }}@{{ remote_backup_host }}:{{ remote_backup_path }}/{{ inventory_hostname }}/postgres/"
    
    if [ $? -eq 0 ]; then
        echo "Remote sync successful" >> $LOG_FILE
    else
        echo "Remote sync failed!" >> $LOG_FILE
    fi
{% endif %}

else
    echo "Backup FAILED!" >> $LOG_FILE
    
{% if slack_webhook %}
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"âŒ PostgreSQL backup failed: $DATABASE on {{ inventory_hostname }}\"}" \
        "{{ slack_webhook }}"
{% endif %}
    
    exit 1
fi

echo "Backup completed: $(date)" >> $LOG_FILE
