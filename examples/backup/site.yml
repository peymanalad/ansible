---
# Comprehensive Backup System
# Ø³ÛŒØ³ØªÙ… Ø¨Ú©Ø§Ù¾â€ŒÚ¯ÛŒØ±ÛŒ Ú©Ø§Ù…Ù„: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ØŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ØŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±

#=========================================
# Part 1: Setup Backup Infrastructure
#=========================================
- name: Setup backup infrastructure
  hosts: all
  become: yes
  
  tasks:
    - name: Install backup tools
      apt:
        name:
          - rsync
          - pigz
          - pv
          - gnupg
          - awscli
        state: present
        update_cache: yes
      tags: install
    
    - name: Create backup directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
        owner: root
        group: root
      loop:
        - "{{ backup_base_dir }}"
        - "{{ backup_base_dir }}/daily"
        - "{{ backup_base_dir }}/weekly"
        - "{{ backup_base_dir }}/monthly"
        - "{{ backup_base_dir }}/logs"
        - "{{ backup_base_dir }}/scripts"
      tags: setup

#=========================================
# Part 2: Database Backups
#=========================================
- name: Setup MySQL backups
  hosts: databases
  become: yes
  
  vars:
    mysql_backup_script: "{{ backup_base_dir }}/scripts/mysql_backup.sh"
  
  tasks:
    - name: Create MySQL backup script
      template:
        src: templates/mysql_backup.sh.j2
        dest: "{{ mysql_backup_script }}"
        mode: '0700'
      when: mysql_databases is defined
      tags: mysql
    
    - name: Setup MySQL backup cron
      cron:
        name: "MySQL backup - {{ item }}"
        minute: "0"
        hour: "2"
        job: "{{ mysql_backup_script }} {{ item }} >> {{ backup_base_dir }}/logs/mysql_{{ item }}.log 2>&1"
      loop: "{{ mysql_databases | default([]) }}"
      tags: mysql

- name: Setup PostgreSQL backups
  hosts: databases
  become: yes
  
  tasks:
    - name: Create PostgreSQL backup script
      template:
        src: templates/postgres_backup.sh.j2
        dest: "{{ backup_base_dir }}/scripts/postgres_backup.sh"
        mode: '0700'
      when: postgres_databases is defined
      tags: postgres
    
    - name: Setup PostgreSQL backup cron
      cron:
        name: "PostgreSQL backup - {{ item }}"
        minute: "30"
        hour: "2"
        job: "{{ backup_base_dir }}/scripts/postgres_backup.sh {{ item }} >> {{ backup_base_dir }}/logs/postgres_{{ item }}.log 2>&1"
      loop: "{{ postgres_databases | default([]) }}"
      tags: postgres

#=========================================
# Part 3: File Backups
#=========================================
- name: Setup file backups
  hosts: webservers
  become: yes
  
  tasks:
    - name: Create file backup script
      template:
        src: templates/file_backup.sh.j2
        dest: "{{ backup_base_dir }}/scripts/file_backup.sh"
        mode: '0700'
      tags: files
    
    - name: Setup file backup cron
      cron:
        name: "File backup"
        minute: "0"
        hour: "3"
        job: "{{ backup_base_dir }}/scripts/file_backup.sh >> {{ backup_base_dir }}/logs/files.log 2>&1"
      tags: files

#=========================================
# Part 4: Backup Rotation
#=========================================
- name: Setup backup rotation
  hosts: all
  become: yes
  
  tasks:
    - name: Create backup rotation script
      copy:
        dest: "{{ backup_base_dir }}/scripts/rotate_backups.sh"
        mode: '0700'
        content: |
          #!/bin/bash
          # Backup Rotation Script
          # Generated by Ansible
          
          BACKUP_DIR="{{ backup_base_dir }}"
          RETENTION_DAYS={{ backup_retention_days }}
          LOG_FILE="${BACKUP_DIR}/logs/rotation.log"
          
          echo "========================================" >> $LOG_FILE
          echo "Rotation started: $(date)" >> $LOG_FILE
          
          # Remove old daily backups
          find ${BACKUP_DIR}/daily -type f -mtime +${RETENTION_DAYS} -delete 2>> $LOG_FILE
          echo "Cleaned daily backups older than ${RETENTION_DAYS} days" >> $LOG_FILE
          
          # Keep last 4 weekly backups
          find ${BACKUP_DIR}/weekly -type f -mtime +28 -delete 2>> $LOG_FILE
          echo "Cleaned weekly backups older than 28 days" >> $LOG_FILE
          
          # Keep last 12 monthly backups
          find ${BACKUP_DIR}/monthly -type f -mtime +365 -delete 2>> $LOG_FILE
          echo "Cleaned monthly backups older than 365 days" >> $LOG_FILE
          
          # Move Sunday's daily to weekly
          DOW=$(date +%u)
          if [ "$DOW" == "7" ]; then
              TODAY=$(date +%Y%m%d)
              cp ${BACKUP_DIR}/daily/*${TODAY}* ${BACKUP_DIR}/weekly/ 2>> $LOG_FILE
              echo "Copied Sunday backup to weekly" >> $LOG_FILE
          fi
          
          # Move 1st of month to monthly
          DOM=$(date +%d)
          if [ "$DOM" == "01" ]; then
              TODAY=$(date +%Y%m%d)
              cp ${BACKUP_DIR}/daily/*${TODAY}* ${BACKUP_DIR}/monthly/ 2>> $LOG_FILE
              echo "Copied 1st of month backup to monthly" >> $LOG_FILE
          fi
          
          echo "Rotation completed: $(date)" >> $LOG_FILE
          
          # Show disk usage
          echo "Disk usage:" >> $LOG_FILE
          du -sh ${BACKUP_DIR}/* >> $LOG_FILE 2>&1
      tags: rotation
    
    - name: Setup rotation cron
      cron:
        name: "Backup rotation"
        minute: "0"
        hour: "5"
        job: "{{ backup_base_dir }}/scripts/rotate_backups.sh"
      tags: rotation

#=========================================
# Part 5: Remote Sync
#=========================================
- name: Setup remote backup sync
  hosts: all:!backup_server
  become: yes
  when: remote_backup_enabled | default(false)
  
  tasks:
    - name: Create remote sync script
      template:
        src: templates/remote_sync.sh.j2
        dest: "{{ backup_base_dir }}/scripts/remote_sync.sh"
        mode: '0700'
      tags: remote
    
    - name: Generate SSH key for backup user
      user:
        name: root
        generate_ssh_key: yes
        ssh_key_type: ed25519
        ssh_key_file: /root/.ssh/backup_key
      register: ssh_key
      tags: remote
    
    - name: Setup remote sync cron
      cron:
        name: "Remote backup sync"
        minute: "0"
        hour: "6"
        job: "{{ backup_base_dir }}/scripts/remote_sync.sh >> {{ backup_base_dir }}/logs/remote_sync.log 2>&1"
      tags: remote

#=========================================
# Part 6: Backup Verification
#=========================================
- name: Setup backup verification
  hosts: all
  become: yes
  
  tasks:
    - name: Create backup verification script
      copy:
        dest: "{{ backup_base_dir }}/scripts/verify_backups.sh"
        mode: '0700'
        content: |
          #!/bin/bash
          # Backup Verification Script
          
          BACKUP_DIR="{{ backup_base_dir }}"
          LOG_FILE="${BACKUP_DIR}/logs/verify.log"
          STATUS=0
          
          echo "========================================" >> $LOG_FILE
          echo "Verification started: $(date)" >> $LOG_FILE
          
          # Check for today's backups
          TODAY=$(date +%Y%m%d)
          BACKUP_COUNT=$(find ${BACKUP_DIR}/daily -name "*${TODAY}*" -type f | wc -l)
          
          if [ "$BACKUP_COUNT" -eq 0 ]; then
              echo "ERROR: No backups found for today!" >> $LOG_FILE
              STATUS=1
          else
              echo "OK: Found $BACKUP_COUNT backup(s) for today" >> $LOG_FILE
          fi
          
          # Check backup file sizes (minimum 1KB)
          for f in ${BACKUP_DIR}/daily/*${TODAY}*; do
              if [ -f "$f" ]; then
                  SIZE=$(stat -c%s "$f")
                  if [ "$SIZE" -lt 1024 ]; then
                      echo "WARNING: $f is suspiciously small ($SIZE bytes)" >> $LOG_FILE
                      STATUS=1
                  fi
              fi
          done
          
          # Check disk space
          DISK_USAGE=$(df -h ${BACKUP_DIR} | awk 'NR==2 {print $5}' | tr -d '%')
          if [ "$DISK_USAGE" -gt 80 ]; then
              echo "WARNING: Backup disk is ${DISK_USAGE}% full" >> $LOG_FILE
              STATUS=1
          fi
          
          {% if slack_webhook %}
          # Send notification if there are issues
          if [ "$STATUS" -ne 0 ]; then
              curl -X POST -H 'Content-type: application/json' \
                  --data "{\"text\":\"âš ï¸ Backup verification failed on {{ inventory_hostname }}\"}" \
                  "{{ slack_webhook }}"
          fi
          {% endif %}
          
          echo "Verification completed with status: $STATUS" >> $LOG_FILE
          exit $STATUS
      tags: verify
    
    - name: Setup verification cron
      cron:
        name: "Backup verification"
        minute: "0"
        hour: "8"
        job: "{{ backup_base_dir }}/scripts/verify_backups.sh"
      tags: verify

#=========================================
# Part 7: Restore Scripts
#=========================================
- name: Create restore scripts
  hosts: all
  become: yes
  
  tasks:
    - name: Create restore helper script
      copy:
        dest: "{{ backup_base_dir }}/scripts/restore.sh"
        mode: '0700'
        content: |
          #!/bin/bash
          # Restore Helper Script
          # Usage: ./restore.sh <backup_type> <backup_file> [target]
          
          BACKUP_TYPE=$1
          BACKUP_FILE=$2
          TARGET=$3
          
          if [ -z "$BACKUP_TYPE" ] || [ -z "$BACKUP_FILE" ]; then
              echo "Usage: $0 <mysql|postgres|files> <backup_file> [target]"
              echo ""
              echo "Examples:"
              echo "  $0 mysql /var/backups/daily/myapp_20240101.sql.gz myapp"
              echo "  $0 postgres /var/backups/daily/analytics_20240101.sql.gz analytics"
              echo "  $0 files /var/backups/daily/files_20240101.tar.gz /var/www/html"
              exit 1
          fi
          
          {% if backup_encryption_enabled %}
          # Decrypt if encrypted
          if [[ "$BACKUP_FILE" == *.gpg ]]; then
              echo "Decrypting backup..."
              gpg --decrypt --passphrase "{{ backup_encryption_key }}" \
                  --batch --yes "$BACKUP_FILE" > "${BACKUP_FILE%.gpg}"
              BACKUP_FILE="${BACKUP_FILE%.gpg}"
          fi
          {% endif %}
          
          case $BACKUP_TYPE in
              mysql)
                  echo "Restoring MySQL database: $TARGET"
                  zcat "$BACKUP_FILE" | mysql "$TARGET"
                  ;;
              postgres)
                  echo "Restoring PostgreSQL database: $TARGET"
                  zcat "$BACKUP_FILE" | psql "$TARGET"
                  ;;
              files)
                  echo "Restoring files to: $TARGET"
                  mkdir -p "$TARGET"
                  tar -xzf "$BACKUP_FILE" -C "$TARGET"
                  ;;
              *)
                  echo "Unknown backup type: $BACKUP_TYPE"
                  exit 1
                  ;;
          esac
          
          echo "Restore completed!"
      tags: restore

#=========================================
# Final Report
#=========================================
- name: Backup system summary
  hosts: all
  
  tasks:
    - name: Show backup configuration
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ğŸ“¦ Backup System Configured                        â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Host: {{ inventory_hostname }}                                 â•‘
          â•‘  Backup Dir: {{ backup_base_dir }}                              â•‘
          â•‘  Retention: {{ backup_retention_days }} days                    â•‘
          â•‘  Remote Sync: {{ 'Enabled' if remote_backup_enabled else 'Disabled' }}
          â•‘  Encryption: {{ 'Enabled' if backup_encryption_enabled else 'Disabled' }}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Cron Schedule:                                                 â•‘
          â•‘    02:00 - Database backups                                    â•‘
          â•‘    03:00 - File backups                                        â•‘
          â•‘    05:00 - Rotation                                            â•‘
          â•‘    06:00 - Remote sync                                         â•‘
          â•‘    08:00 - Verification                                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: always
