# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ MongoDB Replica Set Deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ Ù‡Ø¯Ù:
#    Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ MongoDB Replica Set Ø¨Ø§ 3 Ú¯Ø±Ù‡ Ø¨Ø±Ø§ÛŒ High Availability
#
# âœ… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Setup:
#    - Automatic Failover
#    - Data Redundancy
#    - Read Scaling Ø§Ø² Secondary Ù‡Ø§
#    - Authentication ÙØ¹Ø§Ù„
#
# âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯:
#    1. Ù†ØµØ¨ MongoDB Ø§Ø² Repository Ø±Ø³Ù…ÛŒ
#    2. Ú©Ø§Ù†ÙÛŒÚ¯ Ù‡Ø± Ú¯Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Replica Set
#    3. Initialize Ú©Ø±Ø¯Ù† Replica Set
#    4. Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Admin Ùˆ Application
#    5. ØªÙ†Ø¸ÛŒÙ… Authentication
#
# ğŸ“‹ Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
#    ansible-playbook -i inventory.yml site.yml
#    ansible-playbook -i inventory.yml site.yml --tags install
#    ansible-playbook -i inventory.yml site.yml --tags replicaset
#
# ğŸ“Š Tags Ù…ÙˆØ¬ÙˆØ¯:
#    - install: Ù†ØµØ¨ MongoDB
#    - config: Ú©Ø§Ù†ÙÛŒÚ¯ MongoDB
#    - replicaset: Ø³Ø§Ø®Øª Replica Set
#    - security: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ MongoDB Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ú¯Ø±Ù‡â€ŒÙ‡Ø§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ MongoDB
  hosts: mongodb
  become: yes
  tags: [install, config]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
      package:
        name:
          - gnupg
          - curl
          - python3-pip
        state: present

    - name: Ù†ØµØ¨ pymongo Ø¨Ø±Ø§ÛŒ Ansible
      pip:
        name: pymongo
        state: present

    #---------------------------------------------------------------------------
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† MongoDB Repository
    #---------------------------------------------------------------------------
    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† MongoDB GPG key (Debian)
      apt_key:
        url: "https://pgp.mongodb.com/server-{{ mongodb_version }}.asc"
        state: present
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† MongoDB repository (Debian)
      apt_repository:
        repo: "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/{{ mongodb_version }} multiverse"
        state: present
        filename: mongodb-org-{{ mongodb_version }}
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† MongoDB repository (RedHat)
      yum_repository:
        name: mongodb-org-{{ mongodb_version }}
        description: MongoDB Repository
        baseurl: "https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/{{ mongodb_version }}/x86_64/"
        gpgcheck: yes
        gpgkey: "https://pgp.mongodb.com/server-{{ mongodb_version }}.asc"
        enabled: yes
      when: ansible_os_family == 'RedHat'

    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ MongoDB
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ MongoDB
      package:
        name: mongodb-org
        state: present
        update_cache: yes

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ data
      file:
        path: "{{ mongodb_data_path }}"
        state: directory
        owner: mongodb
        group: mongodb
        mode: '0755'

    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ keyfile
      file:
        path: /etc/mongodb
        state: directory
        owner: mongodb
        group: mongodb
        mode: '0700'

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Keyfile Ø¨Ø±Ø§ÛŒ Replica Set Authentication
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª keyfile Ø±ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ† Ú¯Ø±Ù‡
      shell: openssl rand -base64 756 > /etc/mongodb/keyfile
      args:
        creates: /etc/mongodb/keyfile
      when: inventory_hostname == groups['mongodb'][0]

    - name: Ø®ÙˆØ§Ù†Ø¯Ù† keyfile
      slurp:
        src: /etc/mongodb/keyfile
      register: mongodb_keyfile
      when: inventory_hostname == groups['mongodb'][0]

    - name: Ú©Ù¾ÛŒ keyfile Ø¨Ù‡ Ú¯Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
      copy:
        content: "{{ hostvars[groups['mongodb'][0]]['mongodb_keyfile']['content'] | b64decode }}"
        dest: /etc/mongodb/keyfile
        owner: mongodb
        group: mongodb
        mode: '0400'

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ MongoDB
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ MongoDB
      template:
        src: templates/mongod.conf.j2
        dest: /etc/mongod.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart mongodb

    #---------------------------------------------------------------------------
    # Ø³Ø±ÙˆÛŒØ³ MongoDB
    #---------------------------------------------------------------------------
    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª MongoDB
      systemd:
        name: mongod
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† MongoDB
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ mongodb_port }}"
        delay: 5
        timeout: 60

  handlers:
    - name: restart mongodb
      systemd:
        name: mongod
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Initialize Replica Set
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Initialize Replica Set
  hosts: mongodb_primary
  become: yes
  tags: [replicaset]
  
  tasks:
    #---------------------------------------------------------------------------
    # Initialize Replica Set
    #---------------------------------------------------------------------------
    - name: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Replica Set
      shell: |
        mongosh --quiet --eval "rs.status().ok" 2>/dev/null || echo "0"
      register: rs_status
      changed_when: false

    - name: Initialize Replica Set
      shell: |
        mongosh --quiet --eval '
          rs.initiate({
            _id: "{{ mongodb_replicaset_name }}",
            members: [
              {% for host in groups["mongodb"] %}
              {
                _id: {{ loop.index0 }},
                host: "{{ hostvars[host]["ansible_host"] }}:{{ mongodb_port }}",
                priority: {{ hostvars[host]["mongodb_priority"] }},
                votes: {{ hostvars[host]["mongodb_votes"] }}
              }{% if not loop.last %},{% endif %}
              {% endfor %}
            ]
          })
        '
      when: rs_status.stdout == "0"
      register: rs_init

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Primary
      shell: |
        mongosh --quiet --eval "rs.status().members.filter(m => m.stateStr === 'PRIMARY').length"
      register: primary_count
      until: primary_count.stdout | int >= 1
      retries: 30
      delay: 5


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† MongoDB
  hosts: mongodb_primary
  become: yes
  tags: [security]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Admin User
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Admin User
      shell: |
        mongosh --quiet --eval '
          use admin
          if (db.getUser("{{ mongodb_admin_user }}") === null) {
            db.createUser({
              user: "{{ mongodb_admin_user }}",
              pwd: "{{ mongodb_admin_password }}",
              roles: [
                { role: "root", db: "admin" },
                { role: "userAdminAnyDatabase", db: "admin" },
                { role: "clusterAdmin", db: "admin" }
              ]
            })
            print("Admin user created")
          } else {
            print("Admin user already exists")
          }
        '
      register: admin_user
      changed_when: "'created' in admin_user.stdout"

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Application User
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Application User
      shell: |
        mongosh -u {{ mongodb_admin_user }} -p {{ mongodb_admin_password }} --authenticationDatabase admin --quiet --eval '
          use {{ mongodb_app_database }}
          if (db.getUser("{{ mongodb_app_user }}") === null) {
            db.createUser({
              user: "{{ mongodb_app_user }}",
              pwd: "{{ mongodb_app_password }}",
              roles: [
                { role: "readWrite", db: "{{ mongodb_app_database }}" }
              ]
            })
            print("App user created")
          } else {
            print("App user already exists")
          }
        '
      register: app_user
      changed_when: "'created' in app_user.stdout"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
  hosts: mongodb_primary
  become: no
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… MongoDB Replica Set Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Replica Set: {{ mongodb_replicaset_name }}
          
          ğŸ“‹ Members:
          {% for host in groups['mongodb'] %}
             - {{ hostvars[host]['ansible_host'] }}:{{ mongodb_port }}
          {% endfor %}
          
          ğŸ” Connection String:
          mongodb://{{ mongodb_app_user }}:{{ mongodb_app_password }}@{% for host in groups['mongodb'] %}{{ hostvars[host]['ansible_host'] }}:{{ mongodb_port }}{% if not loop.last %},{% endif %}{% endfor %}/{{ mongodb_app_database }}?replicaSet={{ mongodb_replicaset_name }}
          
          ğŸ“ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙÛŒØ¯:
             - Ø§ØªØµØ§Ù„: mongosh -u admin -p PASSWORD --authenticationDatabase admin
             - ÙˆØ¶Ø¹ÛŒØª: rs.status()
             - Ú©Ø§Ù†ÙÛŒÚ¯: rs.conf()
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
