# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ Redis Cluster Deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ Ù‡Ø¯Ù:
#    Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Redis Cluster Ø¨Ø§:
#    - 3 Master Node Ø¨Ø±Ø§ÛŒ sharding
#    - 3 Replica Node Ø¨Ø±Ø§ÛŒ High Availability
#    - Automatic Failover
#
# âœ… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Setup:
#    - Data Sharding Ø®ÙˆØ¯Ú©Ø§Ø±
#    - Automatic Failover
#    - Read Ø§Ø² Replicas
#    - Persistence Ø¨Ø§ AOF Ùˆ RDB
#
# âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯:
#    1. Ù†ØµØ¨ Redis Ø§Ø² Repository Ø±Ø³Ù…ÛŒ
#    2. Ú©Ø§Ù†ÙÛŒÚ¯ Ù‡Ø± Ú¯Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Cluster Mode
#    3. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Cluster
#    4. ØªÙ†Ø¸ÛŒÙ… Slot Distribution
#    5. Ø§ØªØµØ§Ù„ Replicas Ø¨Ù‡ Masters
#
# ğŸ“‹ Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
#    ansible-playbook -i inventory.yml site.yml
#    ansible-playbook -i inventory.yml site.yml --tags install
#    ansible-playbook -i inventory.yml site.yml --tags cluster
#
# ğŸ“Š Tags Ù…ÙˆØ¬ÙˆØ¯:
#    - install: Ù†ØµØ¨ Redis
#    - config: Ú©Ø§Ù†ÙÛŒÚ¯ Redis
#    - cluster: Ø³Ø§Ø®Øª Cluster
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ Redis Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ú¯Ø±Ù‡â€ŒÙ‡Ø§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Redis
  hosts: redis_cluster
  become: yes
  tags: [install, config]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§ (Debian)
      apt:
        name:
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'

    #---------------------------------------------------------------------------
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Redis Repository
    #---------------------------------------------------------------------------
    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Redis GPG key (Debian)
      apt_key:
        url: https://packages.redis.io/gpg
        state: present
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Redis repository (Debian)
      apt_repository:
        repo: "deb https://packages.redis.io/deb {{ ansible_distribution_release }} main"
        state: present
        filename: redis
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Redis repository (RedHat)
      yum_repository:
        name: redis
        description: Redis Repository
        baseurl: https://packages.redis.io/rpm/
        gpgcheck: yes
        gpgkey: https://packages.redis.io/gpg
        enabled: yes
      when: ansible_os_family == 'RedHat'

    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Redis
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ Redis
      package:
        name: redis
        state: present

    #---------------------------------------------------------------------------
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…
    #---------------------------------------------------------------------------
    - name: ØªÙ†Ø¸ÛŒÙ… vm.overcommit_memory
      sysctl:
        name: vm.overcommit_memory
        value: '1'
        state: present
        reload: yes

    - name: ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† THP
      shell: |
        echo never > /sys/kernel/mm/transparent_hugepage/enabled
        echo never > /sys/kernel/mm/transparent_hugepage/defrag
      changed_when: false

    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
      file:
        path: "{{ item }}"
        state: directory
        owner: redis
        group: redis
        mode: '0755'
      loop:
        - "{{ redis_data_dir }}"
        - "{{ redis_log_dir }}"
        - "{{ redis_config_dir }}"

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ Redis
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ Redis
      template:
        src: templates/redis.conf.j2
        dest: "{{ redis_config_dir }}/redis.conf"
        owner: redis
        group: redis
        mode: '0640'
      notify: restart redis

    #---------------------------------------------------------------------------
    # Ø³Ø±ÙˆÛŒØ³ Redis
    #---------------------------------------------------------------------------
    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª Redis
      systemd:
        name: redis-server
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Redis
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ redis_port }}"
        delay: 2
        timeout: 30

  handlers:
    - name: restart redis
      systemd:
        name: redis-server
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø³Ø§Ø®Øª Redis Cluster
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ø³Ø§Ø®Øª Redis Cluster
  hosts: redis_masters[0]
  become: yes
  tags: [cluster]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Cluster
    #---------------------------------------------------------------------------
    - name: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Cluster
      shell: |
        redis-cli -a {{ redis_password }} cluster info 2>/dev/null | grep cluster_state
      register: cluster_status
      changed_when: false
      failed_when: false

    - name: Ø³Ø§Ø®Øª Redis Cluster
      shell: |
        redis-cli --cluster create \
        {% for host in groups['redis_masters'] %}
        {{ hostvars[host]['ansible_host'] }}:{{ redis_port }} \
        {% endfor %}
        {% for host in groups['redis_replicas'] %}
        {{ hostvars[host]['ansible_host'] }}:{{ redis_port }} \
        {% endfor %}
        --cluster-replicas {{ redis_cluster_replicas }} \
        -a {{ redis_password }} \
        --cluster-yes
      when: "'cluster_state:ok' not in cluster_status.stdout"
      register: cluster_create

    #---------------------------------------------------------------------------
    # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Cluster
    #---------------------------------------------------------------------------
    - name: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Cluster
      shell: |
        redis-cli -a {{ redis_password }} cluster nodes
      register: cluster_nodes
      changed_when: false

    - name: Ù†Ù…Ø§ÛŒØ´ Cluster Nodes
      debug:
        var: cluster_nodes.stdout_lines


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
  hosts: redis_masters[0]
  become: no
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… Redis Cluster Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Master Nodes:
          {% for host in groups['redis_masters'] %}
             - {{ hostvars[host]['ansible_host'] }}:{{ redis_port }}
          {% endfor %}
          
          ğŸ“‹ Replica Nodes:
          {% for host in groups['redis_replicas'] %}
             - {{ hostvars[host]['ansible_host'] }}:{{ redis_port }}
          {% endfor %}
          
          ğŸ” Password: {{ redis_password }}
          
          ğŸ“ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙÛŒØ¯:
             - Ø§ØªØµØ§Ù„: redis-cli -c -h HOST -p {{ redis_port }} -a PASSWORD
             - ÙˆØ¶Ø¹ÛŒØª: redis-cli -a PASSWORD cluster info
             - Ú¯Ø±Ù‡â€ŒÙ‡Ø§: redis-cli -a PASSWORD cluster nodes
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
