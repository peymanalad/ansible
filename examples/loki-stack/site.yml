# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ Loki Stack Deployment (Grafana + Loki + Promtail)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ Ù‡Ø¯Ù:
#    Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ø§ Loki Stack:
#    - Loki: Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ (Ù…Ø´Ø§Ø¨Ù‡ Prometheus Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§)
#    - Grafana: Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ùˆ Visualization
#    - Promtail: Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±Ù‡Ø§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Loki
#
# âœ… Ù…Ø²Ø§ÛŒØ§ÛŒ Loki Ù†Ø³Ø¨Øª Ø¨Ù‡ ELK:
#    - Ù…ØµØ±Ù Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ø³ÛŒØ§Ø± Ú©Ù…ØªØ±
#    - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§Ø¯Ù‡â€ŒØªØ±
#    - ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¹Ø§Ù„ÛŒ Ø¨Ø§ Grafana
#    - Ù‡Ø²ÛŒÙ†Ù‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù…ØªØ±
#
# âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯:
#    1. Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Loki Server
#    2. Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Grafana Ø¨Ø§ DataSource
#    3. Ù†ØµØ¨ Promtail Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§
#    4. ØªÙ†Ø¸ÛŒÙ… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¯Ø± Grafana
#    5. ØªÙ†Ø¸ÛŒÙ… alerting rules
#
# ğŸ“‹ Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
#    ansible-playbook -i inventory.yml site.yml
#    ansible-playbook -i inventory.yml site.yml --tags loki
#    ansible-playbook -i inventory.yml site.yml --tags grafana
#    ansible-playbook -i inventory.yml site.yml --tags promtail
#
# ğŸ“Š Tags Ù…ÙˆØ¬ÙˆØ¯:
#    - loki: Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Loki
#    - grafana: Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Grafana
#    - promtail: Ù†ØµØ¨ Promtail clients
#    - dashboards: Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯Ù‡Ø§
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Loki Server
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Ùˆ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Loki
  hosts: loki
  become: yes
  tags: [loki]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± loki
      user:
        name: loki
        system: yes
        shell: /usr/sbin/nologin
        create_home: no

    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
      file:
        path: "{{ item }}"
        state: directory
        owner: loki
        group: loki
        mode: '0755'
      loop:
        - /etc/loki
        - "{{ loki_data_path }}"
        - "{{ loki_data_path }}/chunks"
        - "{{ loki_data_path }}/boltdb-shipper-active"
        - "{{ loki_data_path }}/boltdb-shipper-cache"
        - /var/log/loki

    #---------------------------------------------------------------------------
    # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Loki
    #---------------------------------------------------------------------------
    - name: Ø¯Ø§Ù†Ù„ÙˆØ¯ Loki
      get_url:
        url: "https://github.com/grafana/loki/releases/download/v{{ loki_version }}/loki-linux-amd64.zip"
        dest: /tmp/loki.zip
        mode: '0644'

    - name: Ù†ØµØ¨ unzip
      package:
        name: unzip
        state: present

    - name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Loki
      unarchive:
        src: /tmp/loki.zip
        dest: /usr/local/bin/
        remote_src: yes
        creates: /usr/local/bin/loki-linux-amd64

    - name: ØªÙ†Ø¸ÛŒÙ… permissions
      file:
        path: /usr/local/bin/loki-linux-amd64
        mode: '0755'

    - name: Ø³Ø§Ø®Øª symlink
      file:
        src: /usr/local/bin/loki-linux-amd64
        dest: /usr/local/bin/loki
        state: link

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ Loki
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ loki
      template:
        src: templates/loki-config.yml.j2
        dest: /etc/loki/config.yml
        owner: loki
        group: loki
        mode: '0640'
      notify: restart loki

    #---------------------------------------------------------------------------
    # Systemd Service
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Loki systemd service
      copy:
        dest: /etc/systemd/system/loki.service
        content: |
          [Unit]
          Description=Loki Log Aggregation System
          After=network-online.target
          Wants=network-online.target
          
          [Service]
          Type=simple
          User=loki
          Group=loki
          ExecStart=/usr/local/bin/loki -config.file=/etc/loki/config.yml
          Restart=on-failure
          RestartSec=5
          LimitNOFILE=65536
          
          [Install]
          WantedBy=multi-user.target
      notify: restart loki

    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª Loki
      systemd:
        name: loki
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Loki
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ loki_http_port }}"
        delay: 5
        timeout: 60

  handlers:
    - name: restart loki
      systemd:
        name: loki
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Grafana
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Ùˆ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Grafana
  hosts: grafana
  become: yes
  tags: [grafana]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Grafana
    #---------------------------------------------------------------------------
    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Grafana GPG key (Debian)
      apt_key:
        url: https://apt.grafana.com/gpg.key
        state: present
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Grafana repository (Debian)
      apt_repository:
        repo: "deb https://apt.grafana.com stable main"
        state: present
        filename: grafana
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Grafana repository (RedHat)
      copy:
        dest: /etc/yum.repos.d/grafana.repo
        content: |
          [grafana]
          name=grafana
          baseurl=https://rpm.grafana.com
          repo_gpgcheck=1
          enabled=1
          gpgcheck=1
          gpgkey=https://rpm.grafana.com/gpg.key
          sslverify=1
          sslcacert=/etc/pki/tls/certs/ca-bundle.crt
      when: ansible_os_family == 'RedHat'

    - name: Ù†ØµØ¨ Grafana
      package:
        name: grafana
        state: present

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ Grafana
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ grafana.ini
      template:
        src: templates/grafana.ini.j2
        dest: /etc/grafana/grafana.ini
        owner: root
        group: grafana
        mode: '0640'
      notify: restart grafana

    #---------------------------------------------------------------------------
    # ØªÙ†Ø¸ÛŒÙ… DataSource - Loki
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ provisioning
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: grafana
        mode: '0755'
      loop:
        - /etc/grafana/provisioning/datasources
        - /etc/grafana/provisioning/dashboards

    - name: Ú©Ø§Ù†ÙÛŒÚ¯ Loki datasource
      copy:
        dest: /etc/grafana/provisioning/datasources/loki.yml
        content: |
          apiVersion: 1
          datasources:
            - name: Loki
              type: loki
              access: proxy
              url: http://{{ hostvars[groups['loki'][0]]['ansible_host'] }}:{{ loki_http_port }}
              isDefault: true
              editable: false
              jsonData:
                maxLines: 1000
        owner: root
        group: grafana
        mode: '0640'
      notify: restart grafana

    #---------------------------------------------------------------------------
    # Ø³Ø±ÙˆÛŒØ³ Grafana
    #---------------------------------------------------------------------------
    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª Grafana
      systemd:
        name: grafana-server
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† Grafana
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ grafana_http_port }}"
        delay: 5
        timeout: 60

  handlers:
    - name: restart grafana
      systemd:
        name: grafana-server
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ Promtail Ø±ÙˆÛŒ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Promtail Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§
  hosts: promtail
  become: yes
  tags: [promtail]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± promtail
      user:
        name: promtail
        system: yes
        shell: /usr/sbin/nologin
        create_home: no
        groups: adm,systemd-journal
        append: yes

    - name: Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§
      file:
        path: "{{ item }}"
        state: directory
        owner: promtail
        group: promtail
        mode: '0755'
      loop:
        - /etc/promtail
        - /var/lib/promtail

    #---------------------------------------------------------------------------
    # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Promtail
    #---------------------------------------------------------------------------
    - name: Ø¯Ø§Ù†Ù„ÙˆØ¯ Promtail
      get_url:
        url: "https://github.com/grafana/loki/releases/download/v{{ promtail_version }}/promtail-linux-amd64.zip"
        dest: /tmp/promtail.zip
        mode: '0644'

    - name: Ù†ØµØ¨ unzip
      package:
        name: unzip
        state: present

    - name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Promtail
      unarchive:
        src: /tmp/promtail.zip
        dest: /usr/local/bin/
        remote_src: yes
        creates: /usr/local/bin/promtail-linux-amd64

    - name: ØªÙ†Ø¸ÛŒÙ… permissions
      file:
        path: /usr/local/bin/promtail-linux-amd64
        mode: '0755'

    - name: Ø³Ø§Ø®Øª symlink
      file:
        src: /usr/local/bin/promtail-linux-amd64
        dest: /usr/local/bin/promtail
        state: link

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ Promtail
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ Promtail
      template:
        src: templates/promtail-config.yml.j2
        dest: /etc/promtail/config.yml
        owner: promtail
        group: promtail
        mode: '0640'
      notify: restart promtail

    #---------------------------------------------------------------------------
    # Systemd Service
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Promtail systemd service
      copy:
        dest: /etc/systemd/system/promtail.service
        content: |
          [Unit]
          Description=Promtail Log Collector
          After=network-online.target
          Wants=network-online.target
          
          [Service]
          Type=simple
          User=promtail
          Group=promtail
          ExecStart=/usr/local/bin/promtail -config.file=/etc/promtail/config.yml
          Restart=on-failure
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
      notify: restart promtail

    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª Promtail
      systemd:
        name: promtail
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: restart promtail
      systemd:
        name: promtail
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ
  hosts: grafana
  become: no
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… Loki Stack Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Grafana URL: http://{{ ansible_host }}:{{ grafana_http_port }}
          
          ğŸ” Ú©Ø§Ø±Ø¨Ø±: {{ grafana_admin_user }}
          ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: {{ grafana_admin_password }}
          
          ğŸ“ Loki URL: http://{{ hostvars[groups['loki'][0]]['ansible_host'] }}:{{ loki_http_port }}
          
          ğŸ” Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§:
             1. ÙˆØ§Ø±Ø¯ Grafana Ø´ÙˆÛŒØ¯
             2. Ø¨Ù‡ Explore Ø¨Ø±ÙˆÛŒØ¯
             3. Loki Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
             4. Ø§Ø² LogQL Ø¨Ø±Ø§ÛŒ Query Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
          
          ğŸ“‹ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ LogQL:
             - Ù‡Ù…Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§: {job="varlogs"}
             - ÙÛŒÙ„ØªØ±: {job="varlogs"} |= "error"
             - Regex: {job="nginx"} |~ "5[0-9]{2}"
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
