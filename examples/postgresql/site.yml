# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ PostgreSQL Installation and Configuration Playbook
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ Ù‡Ø¯Ù:
#    Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ PostgreSQL Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Production
#    Ø´Ø§Ù…Ù„ Primary Ùˆ Replica servers
#
# âœ… Ù…Ø±Ø§Ø­Ù„ Ø§Ø¬Ø±Ø§:
#    1. Ù†ØµØ¨ PostgreSQL Ø§Ø² repository Ø±Ø³Ù…ÛŒ
#    2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª performance Ùˆ security
#    3. Ø³Ø§Ø®Øª databases Ùˆ users
#    4. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ streaming replication
#    5. ØªÙ†Ø¸ÛŒÙ… backup Ø®ÙˆØ¯Ú©Ø§Ø±
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
#===============================================
# Part 1: Install PostgreSQL on all nodes
#===============================================
- name: Install PostgreSQL
  hosts: postgres_primary:postgres_replica
  become: yes
  
  tasks:
    - name: Install prerequisites
      apt:
        name:
          - wget
          - gnupg2
          - lsb-release
          - python3-psycopg2
          - acl
        state: present
        update_cache: yes
      tags: install

    - name: Add PostgreSQL GPG key
      apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present
      tags: install

    - name: Add PostgreSQL repository
      apt_repository:
        repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present
        filename: pgdg
      tags: install

    - name: Install PostgreSQL
      apt:
        name:
          - "postgresql-{{ postgres_version }}"
          - "postgresql-contrib-{{ postgres_version }}"
          - "postgresql-client-{{ postgres_version }}"
        state: present
        update_cache: yes
      tags: install

    - name: Ensure PostgreSQL is started
      systemd:
        name: postgresql
        state: started
        enabled: yes
      tags: install

#===============================================
# Part 2: Configure Primary Server
#===============================================
- name: Configure PostgreSQL Primary
  hosts: postgres_primary
  become: yes
  become_user: postgres
  
  tasks:
    - name: Configure postgresql.conf
      lineinfile:
        path: "{{ postgres_config_dir }}/postgresql.conf"
        regexp: "^#?{{ item.key }} ="
        line: "{{ item.key }} = {{ item.value }}"
      loop:
        - { key: "listen_addresses", value: "'{{ postgres_listen_addresses }}'" }
        - { key: "port", value: "{{ postgres_port }}" }
        - { key: "max_connections", value: "{{ postgres_max_connections }}" }
        - { key: "shared_buffers", value: "{{ postgres_shared_buffers }}" }
        - { key: "effective_cache_size", value: "{{ postgres_effective_cache_size }}" }
        - { key: "work_mem", value: "{{ postgres_work_mem }}" }
        - { key: "maintenance_work_mem", value: "{{ postgres_maintenance_work_mem }}" }
        - { key: "wal_level", value: "{{ postgres_wal_level }}" }
        - { key: "max_wal_senders", value: "{{ postgres_max_wal_senders }}" }
        - { key: "wal_keep_size", value: "{{ postgres_wal_keep_size }}" }
        - { key: "hot_standby", value: "on" }
        - { key: "logging_collector", value: "on" }
        - { key: "log_directory", value: "'{{ postgres_log_dir }}'" }
        - { key: "log_filename", value: "'postgresql-%Y-%m-%d.log'" }
        - { key: "log_statement", value: "'ddl'" }
        - { key: "log_min_duration_statement", value: "1000" }
      notify: Restart PostgreSQL
      tags: config

    - name: Configure pg_hba.conf for local connections
      blockinfile:
        path: "{{ postgres_config_dir }}/pg_hba.conf"
        block: |
          # Application connections
          host    all             all             192.168.1.0/24          scram-sha-256
          
          # Replication connections
          host    replication     {{ postgres_replication_user }}    192.168.1.0/24    scram-sha-256
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
      notify: Reload PostgreSQL
      tags: config

    - name: Create application users
      postgresql_user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        role_attr_flags: "{{ item.role_attr_flags }}"
        state: present
      loop: "{{ postgres_users }}"
      no_log: true
      tags: databases

    - name: Create databases
      postgresql_db:
        name: "{{ item.name }}"
        owner: "{{ item.owner }}"
        encoding: "{{ item.encoding | default('UTF8') }}"
        lc_collate: "{{ item.lc_collate | default('en_US.UTF-8') }}"
        lc_ctype: "{{ item.lc_ctype | default('en_US.UTF-8') }}"
        state: present
      loop: "{{ postgres_databases }}"
      tags: databases

    - name: Create replication user
      postgresql_user:
        name: "{{ postgres_replication_user }}"
        password: "{{ postgres_replication_password }}"
        role_attr_flags: REPLICATION,LOGIN
        state: present
      when: postgres_replication_enabled
      no_log: true
      tags: replication

    - name: Grant readonly access
      postgresql_privs:
        db: "{{ item.name }}"
        role: readonly
        type: table
        objs: ALL_IN_SCHEMA
        privs: SELECT
      loop: "{{ postgres_databases }}"
      ignore_errors: yes
      tags: databases

  handlers:
    - name: Restart PostgreSQL
      become_user: root
      systemd:
        name: postgresql
        state: restarted

    - name: Reload PostgreSQL
      become_user: root
      systemd:
        name: postgresql
        state: reloaded

#===============================================
# Part 3: Configure Replica Servers
#===============================================
- name: Configure PostgreSQL Replicas
  hosts: postgres_replica
  become: yes
  
  tasks:
    - name: Stop PostgreSQL on replica
      systemd:
        name: postgresql
        state: stopped
      tags: replication

    - name: Remove existing data directory
      file:
        path: "{{ postgres_data_dir }}"
        state: absent
      tags: replication

    - name: Create base backup from primary
      become_user: postgres
      command: >
        pg_basebackup -h {{ hostvars[groups['postgres_primary'][0]].ansible_host }}
        -D {{ postgres_data_dir }}
        -U {{ postgres_replication_user }}
        -P -v -R -X stream -C -S replica_{{ inventory_hostname | replace('-', '_') }}
      environment:
        PGPASSWORD: "{{ postgres_replication_password }}"
      tags: replication

    - name: Configure replica settings
      become_user: postgres
      lineinfile:
        path: "{{ postgres_config_dir }}/postgresql.conf"
        regexp: "^#?{{ item.key }} ="
        line: "{{ item.key }} = {{ item.value }}"
      loop:
        - { key: "hot_standby", value: "on" }
        - { key: "primary_conninfo", value: "'host={{ hostvars[groups[\"postgres_primary\"][0]].ansible_host }} port=5432 user={{ postgres_replication_user }} password={{ postgres_replication_password }}'" }
      tags: replication

    - name: Start PostgreSQL on replica
      systemd:
        name: postgresql
        state: started
      tags: replication

#===============================================
# Part 4: Setup Backup
#===============================================
- name: Setup PostgreSQL Backup
  hosts: postgres_primary
  become: yes
  
  tasks:
    - name: Create backup directory
      file:
        path: "{{ postgres_backup_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: '0700'
      tags: backup

    - name: Create backup script
      copy:
        dest: /usr/local/bin/pg_backup.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # PostgreSQL Backup Script
          # Generated by Ansible
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          BACKUP_DIR="{{ postgres_backup_dir }}"
          DATE=$(date +%Y%m%d_%H%M%S)
          RETENTION_DAYS={{ postgres_backup_retention_days }}
          LOG_FILE="${BACKUP_DIR}/backup.log"
          
          echo "========================================" >> $LOG_FILE
          echo "Backup started: $(date)" >> $LOG_FILE
          
          # Backup all databases
          {% for db in postgres_databases %}
          echo "Backing up {{ db.name }}..." >> $LOG_FILE
          sudo -u postgres pg_dump -Fc {{ db.name }} > "${BACKUP_DIR}/{{ db.name }}_${DATE}.dump"
          if [ $? -eq 0 ]; then
              echo "âœ… {{ db.name }} backup successful" >> $LOG_FILE
          else
              echo "âŒ {{ db.name }} backup FAILED" >> $LOG_FILE
          fi
          {% endfor %}
          
          # Backup globals (roles, tablespaces)
          echo "Backing up globals..." >> $LOG_FILE
          sudo -u postgres pg_dumpall --globals-only > "${BACKUP_DIR}/globals_${DATE}.sql"
          
          # Cleanup old backups
          find ${BACKUP_DIR} -name "*.dump" -mtime +${RETENTION_DAYS} -delete
          find ${BACKUP_DIR} -name "*.sql" -mtime +${RETENTION_DAYS} -delete
          
          echo "Backup completed: $(date)" >> $LOG_FILE
          echo "Disk usage: $(du -sh ${BACKUP_DIR})" >> $LOG_FILE
      tags: backup

    - name: Setup backup cron job
      cron:
        name: "PostgreSQL backup"
        minute: "0"
        hour: "2"
        job: "/usr/local/bin/pg_backup.sh"
        user: root
      tags: backup

#===============================================
# Part 5: Display Status
#===============================================
- name: Display PostgreSQL Status
  hosts: postgres_primary
  become: yes
  become_user: postgres
  
  tasks:
    - name: Check replication status
      command: psql -c "SELECT client_addr, state, sync_state FROM pg_stat_replication;"
      register: replication_status
      changed_when: false
      when: postgres_replication_enabled
      tags: status

    - name: Check database sizes
      command: psql -c "SELECT datname, pg_size_pretty(pg_database_size(datname)) as size FROM pg_database WHERE datistemplate = false;"
      register: db_sizes
      changed_when: false
      tags: status

    - name: Display summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ğŸ˜ PostgreSQL Setup Complete!                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Version: {{ postgres_version }}
          â•‘  Primary: {{ hostvars[groups['postgres_primary'][0]].ansible_host }}:{{ postgres_port }}
          â•‘  Data Dir: {{ postgres_data_dir }}
          â•‘                                                                â•‘
          â•‘  Databases:                                                    â•‘
          {% for db in postgres_databases %}
          â•‘    - {{ db.name }} (owner: {{ db.owner }})
          {% endfor %}
          â•‘                                                                â•‘
          â•‘  Users:                                                        â•‘
          {% for user in postgres_users %}
          â•‘    - {{ user.name }}
          {% endfor %}
          â•‘                                                                â•‘
          {% if postgres_replication_enabled %}
          â•‘  Replication Status:                                           â•‘
          {{ replication_status.stdout | indent(10) }}
          {% endif %}
          â•‘                                                                â•‘
          â•‘  Database Sizes:                                               â•‘
          {{ db_sizes.stdout | indent(10) }}
          â•‘                                                                â•‘
          â•‘  Connection String:                                            â•‘
          â•‘    postgresql://user:pass@{{ hostvars[groups['postgres_primary'][0]].ansible_host }}:{{ postgres_port }}/dbname
          â•‘                                                                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: status
