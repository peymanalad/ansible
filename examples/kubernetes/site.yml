---
# Kubernetes Cluster Setup with kubeadm
# راه‌اندازی کامل کلاستر Kubernetes

#=========================================
# Part 1: Prerequisites for all nodes
#=========================================
- name: Prepare all Kubernetes nodes
  hosts: k8s_masters:k8s_workers
  become: yes
  
  tasks:
    #-----------------------------------------
    # System preparation
    #-----------------------------------------
    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
      tags: prep

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - nfs-common
        state: present
      tags: prep

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0
      tags: prep

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '\sswap\s'
        state: absent
      tags: prep

    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter
      tags: prep

    - name: Ensure modules load on boot
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        mode: '0644'
      tags: prep

    - name: Set kernel parameters for Kubernetes
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }
      tags: prep

    #-----------------------------------------
    # Install containerd
    #-----------------------------------------
    - name: Install containerd
      apt:
        name: containerd
        state: present
      when: container_runtime == 'containerd'
      tags: runtime

    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory
      when: container_runtime == 'containerd'
      tags: runtime

    - name: Generate default containerd config
      command: containerd config default
      register: containerd_config
      when: container_runtime == 'containerd'
      tags: runtime

    - name: Save containerd config
      copy:
        content: "{{ containerd_config.stdout }}"
        dest: /etc/containerd/config.toml
      when: container_runtime == 'containerd'
      tags: runtime

    - name: Enable SystemdCgroup in containerd
      lineinfile:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        line: '            SystemdCgroup = true'
      when: container_runtime == 'containerd'
      notify: Restart containerd
      tags: runtime

    - name: Start and enable containerd
      systemd:
        name: containerd
        state: started
        enabled: yes
      when: container_runtime == 'containerd'
      tags: runtime

    #-----------------------------------------
    # Install Kubernetes packages
    #-----------------------------------------
    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: k8s

    - name: Add Kubernetes GPG key
      get_url:
        url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key"
        dest: /etc/apt/keyrings/kubernetes-apt-keyring.asc
        mode: '0644'
      tags: k8s

    - name: Add Kubernetes repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.asc] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /"
        state: present
        filename: kubernetes
      tags: k8s

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes
      tags: k8s

    - name: Hold Kubernetes packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl
      tags: k8s

    - name: Enable and start kubelet
      systemd:
        name: kubelet
        state: started
        enabled: yes
      tags: k8s

  handlers:
    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted

#=========================================
# Part 2: Initialize Master Node
#=========================================
- name: Initialize Kubernetes Master
  hosts: k8s_masters
  become: yes
  
  tasks:
    - name: Check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_init
      tags: master

    - name: Initialize Kubernetes cluster
      command: >
        kubeadm init
        --pod-network-cidr={{ pod_network_cidr }}
        --service-cidr={{ service_cidr }}
        --control-plane-endpoint={{ control_plane_endpoint }}
        --upload-certs
      when: not k8s_init.stat.exists
      register: kubeadm_output
      tags: master

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'
      tags: master

    - name: Copy admin.conf to root's .kube
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'
      tags: master

    - name: Create .kube directory for regular user
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        mode: '0755'
      tags: master

    - name: Copy admin.conf to user's .kube
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        mode: '0600'
      tags: master

    #-----------------------------------------
    # Install CNI Plugin
    #-----------------------------------------
    - name: Install Calico CNI
      command: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.4/manifests/calico.yaml
      when: cni_plugin == 'calico'
      tags: cni

    - name: Install Flannel CNI
      command: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: cni_plugin == 'flannel'
      tags: cni

    - name: Install Cilium CNI
      block:
        - name: Download Cilium CLI
          get_url:
            url: https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
            dest: /tmp/cilium.tar.gz

        - name: Extract Cilium CLI
          unarchive:
            src: /tmp/cilium.tar.gz
            dest: /usr/local/bin
            remote_src: yes

        - name: Install Cilium
          command: cilium install
      when: cni_plugin == 'cilium'
      tags: cni

    #-----------------------------------------
    # Get join command
    #-----------------------------------------
    - name: Generate join command
      command: kubeadm token create --print-join-command
      register: join_command
      tags: master

    - name: Save join command
      set_fact:
        k8s_join_command: "{{ join_command.stdout }}"
      tags: master

#=========================================
# Part 3: Join Worker Nodes
#=========================================
- name: Join Worker Nodes to Cluster
  hosts: k8s_workers
  become: yes
  
  tasks:
    - name: Check if node is already part of cluster
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf
      tags: worker

    - name: Join worker to cluster
      command: "{{ hostvars[groups['k8s_masters'][0]]['k8s_join_command'] }}"
      when: not kubelet_conf.stat.exists
      tags: worker

#=========================================
# Part 4: Install Addons
#=========================================
- name: Install Kubernetes Addons
  hosts: k8s_masters
  become: yes
  
  tasks:
    - name: Wait for all nodes to be ready
      command: kubectl wait --for=condition=Ready nodes --all --timeout=300s
      tags: addons

    #-----------------------------------------
    # Metrics Server
    #-----------------------------------------
    - name: Install Metrics Server
      command: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
      when: install_metrics_server | default(false)
      tags: addons

    - name: Patch Metrics Server for insecure TLS
      command: >
        kubectl patch deployment metrics-server -n kube-system 
        --type='json' 
        -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
      when: install_metrics_server | default(false)
      ignore_errors: yes
      tags: addons

    #-----------------------------------------
    # Ingress Nginx
    #-----------------------------------------
    - name: Install Ingress Nginx
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/baremetal/deploy.yaml
      when: install_ingress_nginx | default(false)
      tags: addons

    #-----------------------------------------
    # Kubernetes Dashboard
    #-----------------------------------------
    - name: Install Kubernetes Dashboard
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
      when: install_dashboard | default(false)
      tags: addons

    - name: Create dashboard admin user
      copy:
        dest: /tmp/dashboard-admin.yaml
        content: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - kind: ServiceAccount
            name: admin-user
            namespace: kubernetes-dashboard
      when: install_dashboard | default(false)
      tags: addons

    - name: Apply dashboard admin user
      command: kubectl apply -f /tmp/dashboard-admin.yaml
      when: install_dashboard | default(false)
      tags: addons

    - name: Get dashboard token
      command: kubectl -n kubernetes-dashboard create token admin-user
      register: dashboard_token
      when: install_dashboard | default(false)
      tags: addons

#=========================================
# Part 5: Final Status
#=========================================
- name: Display Cluster Status
  hosts: k8s_masters
  become: yes
  
  tasks:
    - name: Get cluster info
      command: kubectl cluster-info
      register: cluster_info
      tags: status

    - name: Get nodes
      command: kubectl get nodes -o wide
      register: nodes_info
      tags: status

    - name: Display cluster summary
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════════╗
          ║           ☸️  Kubernetes Cluster Ready!                         ║
          ╠════════════════════════════════════════════════════════════════╣
          ║                                                                ║
          ║  Cluster Name: {{ cluster_name }}
          ║  K8s Version: {{ k8s_version }}
          ║  CNI Plugin: {{ cni_plugin }}
          ║  Container Runtime: {{ container_runtime }}
          ║                                                                ║
          ║  API Server: {{ control_plane_endpoint }}
          ║  Pod CIDR: {{ pod_network_cidr }}
          ║  Service CIDR: {{ service_cidr }}
          ║                                                                ║
          ╠════════════════════════════════════════════════════════════════╣
          ║  Nodes:                                                        ║
          ╠════════════════════════════════════════════════════════════════╣
          {{ nodes_info.stdout }}
          ╠════════════════════════════════════════════════════════════════╣
          {% if install_dashboard | default(false) %}
          ║  Dashboard Token (save this!):                                 ║
          ║  {{ dashboard_token.stdout[:50] }}...
          {% endif %}
          ║                                                                ║
          ║  To access cluster from your local machine:                    ║
          ║    scp root@{{ control_plane_endpoint.split(':')[0] }}:/etc/kubernetes/admin.conf ~/.kube/config
          ║                                                                ║
          ╚════════════════════════════════════════════════════════════════╝
      tags: status
