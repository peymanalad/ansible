# ═══════════════════════════════════════════════════════════════════════════════
# GitLab CE Configuration
# Generated by Ansible - Do not edit manually
# ═══════════════════════════════════════════════════════════════════════════════

# External URL
external_url '{{ gitlab_external_url }}'

#---------------------------------------
# SSL Configuration
#---------------------------------------
{% if gitlab_ssl_enabled %}
nginx['redirect_http_to_https'] = true
nginx['ssl_certificate'] = "/etc/gitlab/ssl/{{ gitlab_domain }}.crt"
nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/{{ gitlab_domain }}.key"

{% if gitlab_letsencrypt_enabled %}
letsencrypt['enable'] = true
letsencrypt['contact_emails'] = ['{{ gitlab_letsencrypt_email }}']
letsencrypt['auto_renew'] = true
letsencrypt['auto_renew_hour'] = 3
letsencrypt['auto_renew_minute'] = 30
{% endif %}
{% endif %}

#---------------------------------------
# Container Registry
#---------------------------------------
{% if gitlab_registry_enabled %}
registry_external_url 'https://{{ gitlab_registry_domain }}'
registry['enable'] = true
registry_nginx['enable'] = true
registry_nginx['ssl_certificate'] = "/etc/gitlab/ssl/{{ gitlab_registry_domain }}.crt"
registry_nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/{{ gitlab_registry_domain }}.key"
{% endif %}

#---------------------------------------
# GitLab Pages
#---------------------------------------
{% if gitlab_pages_enabled %}
pages_external_url 'https://{{ gitlab_pages_domain }}'
gitlab_pages['enable'] = true
gitlab_pages['inplace_chroot'] = true
{% endif %}

#---------------------------------------
# SMTP Configuration
#---------------------------------------
{% if gitlab_smtp_enabled %}
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "{{ gitlab_smtp_server }}"
gitlab_rails['smtp_port'] = {{ gitlab_smtp_port }}
gitlab_rails['smtp_user_name'] = "{{ gitlab_smtp_user }}"
gitlab_rails['smtp_password'] = "{{ gitlab_smtp_password }}"
gitlab_rails['smtp_domain'] = "{{ gitlab_smtp_domain }}"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = false
gitlab_rails['gitlab_email_from'] = '{{ gitlab_email_from }}'
gitlab_rails['gitlab_email_reply_to'] = '{{ gitlab_email_reply_to }}'
{% endif %}

#---------------------------------------
# Performance Tuning
#---------------------------------------
# Puma workers (web server)
puma['worker_processes'] = {{ gitlab_puma_workers }}
puma['per_worker_max_memory_mb'] = 1024

# Sidekiq (background jobs)
sidekiq['concurrency'] = {{ gitlab_sidekiq_concurrency }}

# PostgreSQL
postgresql['shared_buffers'] = "{{ gitlab_postgresql_shared_buffers }}"

# Prometheus (monitoring)
prometheus_monitoring['enable'] = true

# Gitaly (git operations)
gitaly['configuration'] = {
  concurrency: [
    {
      rpc: "/gitaly.SmartHTTPService/PostReceivePack",
      max_per_repo: 3
    },
    {
      rpc: "/gitaly.SSHService/SSHUploadPack",
      max_per_repo: 3
    }
  ]
}

#---------------------------------------
# Backup Configuration
#---------------------------------------
gitlab_rails['backup_path'] = "{{ gitlab_backup_path }}"
gitlab_rails['backup_keep_time'] = {{ gitlab_backup_keep_time }}
gitlab_rails['backup_archive_permissions'] = 0644

#---------------------------------------
# Security Settings
#---------------------------------------
# Disable signup (optional)
# gitlab_rails['gitlab_signup_enabled'] = false

# Password requirements
gitlab_rails['password_complexity'] = [
  "min_length" => 8,
  "require_lowercase" => 1,
  "require_uppercase" => 1,
  "require_number" => 1
]

# Rate limiting
gitlab_rails['rack_attack_git_basic_auth'] = {
  'enabled' => true,
  'ip_whitelist' => ["127.0.0.1"],
  'maxretry' => 10,
  'findtime' => 60,
  'bantime' => 3600
}

#---------------------------------------
# Time Zone
#---------------------------------------
gitlab_rails['time_zone'] = 'Asia/Tehran'

#---------------------------------------
# Logging
#---------------------------------------
logging['logrotate_frequency'] = "daily"
logging['logrotate_maxsize'] = nil
logging['logrotate_rotate'] = 30
logging['logrotate_compress'] = "compress"
logging['logrotate_method'] = "copytruncate"
logging['logrotate_delaycompress'] = "delaycompress"

#---------------------------------------
# Object Storage (optional - for S3/MinIO)
#---------------------------------------
# gitlab_rails['object_store']['enabled'] = true
# gitlab_rails['object_store']['connection'] = {
#   'provider' => 'AWS',
#   'region' => 'us-east-1',
#   'aws_access_key_id' => 'ACCESS_KEY',
#   'aws_secret_access_key' => 'SECRET_KEY'
# }
# gitlab_rails['object_store']['objects']['artifacts']['bucket'] = 'gitlab-artifacts'
# gitlab_rails['object_store']['objects']['lfs']['bucket'] = 'gitlab-lfs'
# gitlab_rails['object_store']['objects']['uploads']['bucket'] = 'gitlab-uploads'
