# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ RabbitMQ Cluster Deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ Ù‡Ø¯Ù:
#    Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ RabbitMQ Cluster Ø¨Ø§ 3 Ú¯Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Message Queuing
#
# âœ… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Setup:
#    - High Availability Ø¨Ø§ Mirrored Queues
#    - Management Plugin Ø¨Ø±Ø§ÛŒ Web UI
#    - Prometheus Plugin Ø¨Ø±Ø§ÛŒ Monitoring
#    - TLS Support (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
#
# âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯:
#    1. Ù†ØµØ¨ Erlang Ùˆ RabbitMQ
#    2. Ú©Ø§Ù†ÙÛŒÚ¯ Cluster
#    3. Ø³Ø§Ø®Øª Virtual Hosts Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
#    4. ØªÙ†Ø¸ÛŒÙ… HA Policy
#    5. ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§
#
# ğŸ“‹ Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
#    ansible-playbook -i inventory.yml site.yml
#    ansible-playbook -i inventory.yml site.yml --tags install
#    ansible-playbook -i inventory.yml site.yml --tags cluster
#    ansible-playbook -i inventory.yml site.yml --tags users
#
# ğŸ“Š Tags Ù…ÙˆØ¬ÙˆØ¯:
#    - install: Ù†ØµØ¨ RabbitMQ
#    - config: Ú©Ø§Ù†ÙÛŒÚ¯ RabbitMQ
#    - cluster: Ø³Ø§Ø®Øª Cluster
#    - users: Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
#    - policies: ØªÙ†Ø¸ÛŒÙ… HA Policies
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†ØµØ¨ RabbitMQ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ú¯Ø±Ù‡â€ŒÙ‡Ø§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†ØµØ¨ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ RabbitMQ
  hosts: rabbitmq
  become: yes
  tags: [install, config]
  
  tasks:
    #---------------------------------------------------------------------------
    # ØªÙ†Ø¸ÛŒÙ… /etc/hosts
    #---------------------------------------------------------------------------
    - name: ØªÙ†Ø¸ÛŒÙ… /etc/hosts Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ú¯Ø±Ù‡â€ŒÙ‡Ø§
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item]['ansible_host'] }} {{ item }}"
        state: present
      loop: "{{ groups['rabbitmq'] }}"

    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Erlang (Debian)
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§ (Debian)
      apt:
        name:
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Erlang repository (Debian)
      apt_key:
        url: https://packages.erlang-solutions.com/ubuntu/erlang_solutions.asc
        state: present
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† RabbitMQ GPG key (Debian)
      apt_key:
        url: https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc
        state: present
      when: ansible_os_family == 'Debian'

    - name: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† RabbitMQ repository (Debian)
      apt_repository:
        repo: "deb https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/deb/ubuntu {{ ansible_distribution_release }} main"
        state: present
        filename: rabbitmq
      when: ansible_os_family == 'Debian'

    #---------------------------------------------------------------------------
    # Ù†ØµØ¨ Erlang Ùˆ RabbitMQ
    #---------------------------------------------------------------------------
    - name: Ù†ØµØ¨ Erlang Ùˆ RabbitMQ (Debian)
      apt:
        name:
          - erlang-base
          - erlang-asn1
          - erlang-crypto
          - erlang-eldap
          - erlang-ftp
          - erlang-inets
          - erlang-mnesia
          - erlang-os-mon
          - erlang-parsetools
          - erlang-public-key
          - erlang-runtime-tools
          - erlang-snmp
          - erlang-ssl
          - erlang-syntax-tools
          - erlang-tftp
          - erlang-tools
          - erlang-xmerl
          - rabbitmq-server
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'

    - name: Ù†ØµØ¨ RabbitMQ (RedHat)
      yum:
        name: rabbitmq-server
        state: present
      when: ansible_os_family == 'RedHat'

    #---------------------------------------------------------------------------
    # ØªÙ†Ø¸ÛŒÙ… Erlang Cookie
    #---------------------------------------------------------------------------
    - name: ØªÙ†Ø¸ÛŒÙ… Erlang Cookie
      copy:
        content: "{{ rabbitmq_erlang_cookie }}"
        dest: /var/lib/rabbitmq/.erlang.cookie
        owner: rabbitmq
        group: rabbitmq
        mode: '0400'
      notify: restart rabbitmq

    #---------------------------------------------------------------------------
    # Ú©Ø§Ù†ÙÛŒÚ¯ RabbitMQ
    #---------------------------------------------------------------------------
    - name: Ú©Ø§Ù†ÙÛŒÚ¯ RabbitMQ
      template:
        src: templates/rabbitmq.conf.j2
        dest: /etc/rabbitmq/rabbitmq.conf
        owner: rabbitmq
        group: rabbitmq
        mode: '0640'
      notify: restart rabbitmq

    - name: Ú©Ø§Ù†ÙÛŒÚ¯ Environment
      template:
        src: templates/rabbitmq-env.conf.j2
        dest: /etc/rabbitmq/rabbitmq-env.conf
        owner: rabbitmq
        group: rabbitmq
        mode: '0640'
      notify: restart rabbitmq

    #---------------------------------------------------------------------------
    # ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§
    #---------------------------------------------------------------------------
    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§
      rabbitmq_plugin:
        names:
          - rabbitmq_management
          - rabbitmq_prometheus
          - rabbitmq_shovel
          - rabbitmq_shovel_management
        state: enabled
      notify: restart rabbitmq

    #---------------------------------------------------------------------------
    # Ø³Ø±ÙˆÛŒØ³ RabbitMQ
    #---------------------------------------------------------------------------
    - name: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ§Ø±Øª RabbitMQ
      systemd:
        name: rabbitmq-server
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù† RabbitMQ
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ rabbitmq_amqp_port }}"
        delay: 5
        timeout: 60

  handlers:
    - name: restart rabbitmq
      systemd:
        name: rabbitmq-server
        state: restarted


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø³Ø§Ø®Øª Cluster
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ø³Ø§Ø®Øª RabbitMQ Cluster
  hosts: rabbitmq_slaves
  become: yes
  tags: [cluster]
  serial: 1
  
  tasks:
    #---------------------------------------------------------------------------
    # Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Cluster
    #---------------------------------------------------------------------------
    - name: ØªÙˆÙ‚Ù RabbitMQ app
      shell: rabbitmqctl stop_app

    - name: Ø±ÛŒØ³Øª Ú¯Ø±Ù‡
      shell: rabbitmqctl reset

    - name: Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Cluster
      shell: "rabbitmqctl join_cluster rabbit@{{ groups['rabbitmq_master'][0] }}"
      register: join_result
      failed_when: 
        - join_result.rc != 0
        - "'already_member' not in join_result.stderr"

    - name: Ø§Ø³ØªØ§Ø±Øª RabbitMQ app
      shell: rabbitmqctl start_app


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Virtual Hosts
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ VHosts
  hosts: rabbitmq_master
  become: yes
  tags: [users]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± guest
    #---------------------------------------------------------------------------
    - name: Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± guest
      rabbitmq_user:
        user: guest
        state: absent

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Admin User
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Admin User
      rabbitmq_user:
        user: "{{ rabbitmq_admin_user }}"
        password: "{{ rabbitmq_admin_password }}"
        tags: administrator
        vhost: /
        configure_priv: .*
        read_priv: .*
        write_priv: .*
        state: present

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Virtual Hosts
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Virtual Hosts
      rabbitmq_vhost:
        name: "{{ item.name }}"
        state: present
      loop: "{{ rabbitmq_vhosts }}"

    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª Application User
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª Application User
      rabbitmq_user:
        user: "{{ rabbitmq_app_user }}"
        password: "{{ rabbitmq_app_password }}"
        vhost: "{{ item.name }}"
        configure_priv: .*
        read_priv: .*
        write_priv: .*
        state: present
      loop: "{{ rabbitmq_vhosts }}"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ØªÙ†Ø¸ÛŒÙ… HA Policies
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: ØªÙ†Ø¸ÛŒÙ… HA Policies
  hosts: rabbitmq_master
  become: yes
  tags: [policies]
  
  tasks:
    #---------------------------------------------------------------------------
    # Ø³Ø§Ø®Øª HA Policy
    #---------------------------------------------------------------------------
    - name: Ø³Ø§Ø®Øª HA Policy Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Queue Ù‡Ø§
      rabbitmq_policy:
        name: ha-all
        vhost: "{{ item.name }}"
        pattern: .*
        tags:
          ha-mode: "{{ rabbitmq_ha_mode }}"
          ha-sync-mode: "{{ rabbitmq_ha_sync_mode }}"
        state: present
      loop: "{{ rabbitmq_vhosts }}"

    - name: Ø³Ø§Ø®Øª HA Policy Ø¨Ø±Ø§ÛŒ vhost Ù¾ÛŒØ´â€ŒÙØ±Ø¶
      rabbitmq_policy:
        name: ha-all
        vhost: /
        pattern: .*
        tags:
          ha-mode: "{{ rabbitmq_ha_mode }}"
          ha-sync-mode: "{{ rabbitmq_ha_sync_mode }}"
        state: present


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ
  hosts: rabbitmq_master
  become: yes
  tags: [always]
  
  tasks:
    - name: Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Cluster
      shell: rabbitmqctl cluster_status
      register: cluster_status
      changed_when: false

    - name: Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… RabbitMQ Cluster Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Cluster: {{ rabbitmq_cluster_name }}
          
          ğŸ“‹ Nodes:
          {% for host in groups['rabbitmq'] %}
             - {{ hostvars[host]['ansible_host'] }}:{{ rabbitmq_amqp_port }}
          {% endfor %}
          
          ğŸŒ Management UI:
             http://{{ ansible_host }}:{{ rabbitmq_management_port }}
          
          ğŸ” Admin User: {{ rabbitmq_admin_user }}
          ğŸ”‘ Admin Password: {{ rabbitmq_admin_password }}
          
          ğŸ“ Connection String:
             amqp://{{ rabbitmq_app_user }}:{{ rabbitmq_app_password }}@{{ ansible_host }}:{{ rabbitmq_amqp_port }}/production
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
