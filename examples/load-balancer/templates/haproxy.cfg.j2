# HAProxy Configuration
# Generated by Ansible

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # SSL settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Performance tuning
    maxconn 50000
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    option  redispatch
    
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue   30s
    timeout tunnel  1h
    
    # Error pages
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# Stats Dashboard
#---------------------------------------------------------------------
frontend stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
    stats hide-version

#---------------------------------------------------------------------
# HTTP Frontend (Redirect to HTTPS)
#---------------------------------------------------------------------
frontend http_front
    bind *:{{ haproxy_frontend_port }}
    mode http
    
    # Redirect all HTTP to HTTPS
    http-request redirect scheme https code 301 unless { ssl_fc }
    
    # ACME challenge for Let's Encrypt
    acl is_acme path_beg /.well-known/acme-challenge/
    use_backend acme_backend if is_acme

#---------------------------------------------------------------------
# HTTPS Frontend
#---------------------------------------------------------------------
frontend https_front
    bind *:{{ haproxy_frontend_ssl_port }} ssl crt /etc/haproxy/certs/ alpn h2,http/1.1
    mode http
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
{% if rate_limit_enabled %}
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate({{ rate_limit_period }})
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt {{ rate_limit_requests }} }
{% endif %}
    
    # ACLs for routing
    acl is_api path_beg /api
    acl is_websocket hdr(Upgrade) -i websocket
    
    # Route to appropriate backend
    use_backend api_backend if is_api
    use_backend websocket_backend if is_websocket
    default_backend web_backend

#---------------------------------------------------------------------
# Web Backend
#---------------------------------------------------------------------
backend web_backend
    mode http
    balance {{ lb_algorithm }}
    
    # Health check
    option httpchk GET {{ health_check_uri }}
    http-check expect status 200
    
    # Cookie-based session persistence
    cookie SERVERID insert indirect nocache
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css application/javascript application/json
    
    # Backend servers
{% for host in groups['webservers'] %}
    server {{ host }} {{ hostvars[host].ansible_host }}:80 check inter {{ health_check_interval }} fall 3 rise 2 weight {{ hostvars[host].weight | default(100) }} cookie {{ host }}
{% endfor %}

#---------------------------------------------------------------------
# API Backend
#---------------------------------------------------------------------
backend api_backend
    mode http
    balance leastconn
    
    # Health check
    option httpchk GET /api/health
    http-check expect status 200
    
    # Timeouts for API
    timeout server 60s
    
    # Backend servers
{% for host in groups['api_servers'] %}
    server {{ host }} {{ hostvars[host].ansible_host }}:3000 check inter {{ health_check_interval }} fall 3 rise 2
{% endfor %}

#---------------------------------------------------------------------
# WebSocket Backend
#---------------------------------------------------------------------
backend websocket_backend
    mode http
    balance source
    
    # WebSocket settings
    option http-server-close
    timeout tunnel 1h
    
    # Backend servers (same as web)
{% for host in groups['webservers'] %}
    server {{ host }} {{ hostvars[host].ansible_host }}:80 check
{% endfor %}

#---------------------------------------------------------------------
# ACME Backend (for Let's Encrypt)
#---------------------------------------------------------------------
backend acme_backend
    mode http
    server local 127.0.0.1:8888
