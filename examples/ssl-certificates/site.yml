---
# SSL/TLS Certificate Management with Let's Encrypt
# Ù…Ø¯ÛŒØ±ÛŒØª Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ SSL Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Certbot

- name: Setup SSL Certificates
  hosts: webservers
  become: yes
  
  vars:
    certbot_method: webroot  # webroot or standalone
    nginx_ssl_protocols: "TLSv1.2 TLSv1.3"
    nginx_ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  
  tasks:
    #=========================================
    # 1. Install Certbot
    #=========================================
    - name: Install Certbot and Nginx plugin
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: present
        update_cache: yes
      tags: install

    #=========================================
    # 2. Setup Webroot Directory
    #=========================================
    - name: Create webroot directory for ACME challenge
      file:
        path: "{{ webroot_path }}"
        state: directory
        mode: '0755'
        owner: www-data
        group: www-data
      when: certbot_method == 'webroot'
      tags: setup

    - name: Configure Nginx for ACME challenge
      copy:
        dest: /etc/nginx/snippets/letsencrypt.conf
        content: |
          # Let's Encrypt ACME Challenge
          location ^~ /.well-known/acme-challenge/ {
              default_type "text/plain";
              root {{ webroot_path }};
              allow all;
          }
        mode: '0644'
      notify: Reload Nginx
      tags: setup

    - name: Create strong DH parameters
      command: openssl dhparam -out /etc/nginx/dhparam.pem 2048
      args:
        creates: /etc/nginx/dhparam.pem
      tags: setup

    #=========================================
    # 3. Issue Certificates
    #=========================================
    - name: Check if certificate already exists
      stat:
        path: "/etc/letsencrypt/live/{{ item.domain }}/fullchain.pem"
      loop: "{{ domains }}"
      register: cert_exists
      tags: certificates

    - name: Issue certificates (webroot method)
      command: >
        certbot certonly
        --webroot
        --webroot-path {{ webroot_path }}
        --email {{ letsencrypt_email }}
        --agree-tos
        --non-interactive
        {% if letsencrypt_staging %}--staging{% endif %}
        -d {{ item.item.domain }}
        {% for alias in item.item.aliases | default([]) %}-d {{ alias }} {% endfor %}
      loop: "{{ cert_exists.results }}"
      when: 
        - certbot_method == 'webroot'
        - not item.stat.exists
      register: certbot_output
      tags: certificates

    - name: Issue certificates (standalone method)
      command: >
        certbot certonly
        --standalone
        --email {{ letsencrypt_email }}
        --agree-tos
        --non-interactive
        --preferred-challenges http
        {% if letsencrypt_staging %}--staging{% endif %}
        -d {{ item.item.domain }}
        {% for alias in item.item.aliases | default([]) %}-d {{ alias }} {% endfor %}
      loop: "{{ cert_exists.results }}"
      when: 
        - certbot_method == 'standalone'
        - not item.stat.exists
      tags: certificates

    #=========================================
    # 4. Configure SSL in Nginx
    #=========================================
    - name: Create SSL params snippet
      copy:
        dest: /etc/nginx/snippets/ssl-params.conf
        content: |
          # SSL Settings - Generated by Ansible
          
          # Protocols and Ciphers
          ssl_protocols {{ nginx_ssl_protocols }};
          ssl_ciphers {{ nginx_ssl_ciphers }};
          ssl_prefer_server_ciphers on;
          
          # DH Parameters
          ssl_dhparam /etc/nginx/dhparam.pem;
          
          # SSL Session
          ssl_session_timeout 1d;
          ssl_session_cache shared:SSL:50m;
          ssl_session_tickets off;
          
          # OCSP Stapling
          ssl_stapling on;
          ssl_stapling_verify on;
          resolver 8.8.8.8 8.8.4.4 valid=300s;
          resolver_timeout 5s;
          
          # Security Headers
          add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header X-XSS-Protection "1; mode=block" always;
          add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        mode: '0644'
      notify: Reload Nginx
      tags: nginx

    - name: Create SSL site configuration for each domain
      template:
        src: templates/nginx-ssl-site.conf.j2
        dest: "/etc/nginx/sites-available/{{ item.domain }}"
        mode: '0644'
      loop: "{{ domains }}"
      notify: Reload Nginx
      tags: nginx

    - name: Enable SSL sites
      file:
        src: "/etc/nginx/sites-available/{{ item.domain }}"
        dest: "/etc/nginx/sites-enabled/{{ item.domain }}"
        state: link
      loop: "{{ domains }}"
      notify: Reload Nginx
      tags: nginx

    #=========================================
    # 5. Setup Auto-Renewal
    #=========================================
    - name: Create renewal hook script
      copy:
        dest: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
        content: |
          #!/bin/bash
          # Reload Nginx after certificate renewal
          systemctl reload {{ reload_service }}
        mode: '0755'
      tags: renewal

    - name: Setup renewal cron job
      cron:
        name: "Certbot renewal"
        minute: "{{ renewal_cron_minute }}"
        hour: "{{ renewal_cron_hour }}"
        job: "certbot renew --quiet --deploy-hook '/etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh'"
      tags: renewal

    - name: Test renewal (dry run)
      command: certbot renew --dry-run
      register: renewal_test
      changed_when: false
      tags: test

    - name: Show renewal test result
      debug:
        var: renewal_test.stdout_lines
      tags: test

    #=========================================
    # 6. Certificate Status
    #=========================================
    - name: Get certificate information
      command: "certbot certificates"
      register: cert_info
      changed_when: false
      tags: status

    - name: Display certificate status
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                 ğŸ”’ SSL Certificate Status                       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          {{ cert_info.stdout }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: status

  handlers:
    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
